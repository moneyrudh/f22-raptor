<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>F-22 Game</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
        <style>
            body {
                margin: 0;
                background-color: #1a1a1a;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }
            .canvas-container {
                position: relative;
                width: fit-content;
                height: fit-content;
            }
            canvas {
                background-color: #000;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                outline: 2px solid rgb(247, 247, 247);
            }
            #textCanvas {
                position: absolute;
                right: 2px;
                top: 2px;
                background-color: transparent;
                pointer-events: none;
                outline: none;
            }
            #startTextCanvas {
                position: absolute;
                right: 2px;
                top: 40%;
                background-color: transparent;
                pointer-events: none;
                outline: none;
            }
            #controls {
                position: fixed;
                bottom: 20px;
                color: white;
                font-family: monospace;
                text-align: center;
                width: 100%;
            }
            #submit-modal {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%); /* Slightly above center */
                width: 1300px;
                height: 796px;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-family: 'Press Start 2P', monospace;
            }

            #submit-modal.hidden {
                display: none;
            }

            #username-input {
                width: 300px;
                padding: 12px;
                background: #000;
                border: 2px solid #fff;
                color: #fff;
                font-family: 'Press Start 2P', monospace;
                font-size: 16px;
                text-align: center;
                margin-bottom: 20px;
                outline: none;
            }

            .button-container {
                display: flex;
                gap: 12px;
                width: 300px;
            }

            .modal-btn {
                flex: 1;
                padding: 12px;
                font-family: 'Press Start 2P', monospace;
                font-size: 14px;
                border: none;
                cursor: pointer;
                transition: opacity 0.2s;
            }

            .modal-btn:hover {
                opacity: 0.9;
            }

            .no-btn {
                background: #fff;
                color: #000;
            }

            .submit-btn {
                background: #ff3e3e;
                color: #fff;
            }
        </style>
    </head>
    <body>
        <div class="canvas-container">
            <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
            <canvas id="textCanvas"></canvas>
            <canvas id="startTextCanvas"></canvas>
        </div>
        <div id="submit-modal" class="hidden">
            <input 
                type="text" 
                id="username-input" 
                placeholder="Enter X username" 
                autocomplete="off"
                spellcheck="false"
            />
            <div class="button-container">
              <button class="modal-btn no-btn">NO</button>
              <button class="modal-btn submit-btn">SUBMIT</button>
            </div>
        </div>
        <div id="controls">SPACE / UP - Thrust | ESC - Quit</div>
        <script>
            var Module = {
                canvas: (function () {
                    var canvas = document.getElementById("canvas");
                    canvas.addEventListener(
                        "webglcontextlost",
                        function (e) {
                            e.preventDefault();
                        },
                        false
                    );
                    return canvas;
                })(),
                onRuntimeInitialized: function() {
                    const modal = document.getElementById('submit-modal');
                    const usernameInput = document.getElementById('username-input');
                    let finalScore = 0;
                    
                    modal.classList.add('hidden');
                    
                    // Handle No button
                    document.querySelector('.no-btn').addEventListener('click', () => {
                        location.reload();
                    });
                    
                    // Handle Submit button
                    document.querySelector('.submit-btn').addEventListener('click', async () => {
                        const username = usernameInput.value.trim();
                        if (!username) return;
                        
                        try {
                            // First verify the user exists
                            const verifyRes = await fetch(`http://localhost:3000/verify/${username.toString()}`);
                            const verifyData = await verifyRes.json();
                            
                            if (!verifyData.valid) {
                                alert('User not found on X - check the username and try again');
                                return;
                            }

                            // If verified, submit the score
                            const submitRes = await fetch('http://localhost:3000/submission', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    username, 
                                    score: finalScore 
                                })
                            });

                            if (!submitRes.ok) {
                                const error = await submitRes.json();
                                alert(error.message || 'Failed to submit score');
                                return;
                            }

                            // Success! Reload the game
                            location.reload();
                            
                        } catch (err) {
                            console.error('Submit error:', err);
                            alert('Something went wrong - try again?');
                        }
                    });
                    const gameCanvas = document.getElementById('canvas');
                    const textCanvas = document.getElementById('textCanvas');
                    const startTextCanvas = document.getElementById('startTextCanvas');
                    let gameStarted = false;
                    let score = 0;
                    
                    // match text canvas size to game canvas
                    textCanvas.width = gameCanvas.width * 2;
                    textCanvas.height = gameCanvas.height;
                    startTextCanvas.width = gameCanvas.width * 2;
                    startTextCanvas.height = gameCanvas.height;
                    
                    const scoreCtx = textCanvas.getContext('2d');
                    const startCtx = startTextCanvas.getContext('2d');
                    scoreCtx.imageSmoothingEnabled = false;
                    startCtx.imageSmoothingEnabled = false;

                    Module.setGameState = function(state) {
                        console.log("CALLED SET GAME STATE");
                        if (state === 1) {
                            startTextCanvas.style.display = 'none';
                            gameStarted = true;
                        } else {
                            startTextCanvas.style.display = 'block';
                        }
                    };

                    Module.updateScore = function(_score) {
                        score = _score;
                    };

                    Module.showGameOver = function(_score) {
                        console.log("SETTING FINAL SCORE AS:", _score);
                        finalScore = parseInt(_score);
                        modal.classList.remove('hidden');
                        usernameInput.disabled = false;
                        setTimeout(() => {
                            usernameInput.focus();
                        }, 100);
                    };
                    
                    function drawScore() {
                        scoreCtx.clearRect(0, 0, textCanvas.width, textCanvas.height);
                        scoreCtx.font = '24px "Press Start 2P"';
                        scoreCtx.fillStyle = 'white';
                        scoreCtx.textAlign = 'right';
                        scoreCtx.textBaseline = 'middle';  // vertical center
                        
                        // center both horizontally and vertically
                        scoreCtx.fillText(`SCORE: ${Math.floor(score)}`, 
                            textCanvas.width - 40,   // horizontal center 
                            textCanvas.height / 2   // vertical center
                        );
                        requestAnimationFrame(drawScore);
                    }
                    
                    function drawStartText() {
                        startCtx.clearRect(0, 0, startTextCanvas.width, startTextCanvas.height);
                        startCtx.font = '24px "Press Start 2P"';
                        startCtx.fillStyle = 'white';
                        startCtx.textAlign = 'right';
                        startCtx.textBaseline = 'middle';
                        
                        startCtx.fillText('CLICK TO START', 
                            startTextCanvas.width - 40,
                            startTextCanvas.height / 2
                        );
                        requestAnimationFrame(drawStartText);
                    }
                    
                    drawScore();
                    if (!gameStarted) drawStartText();
                }
            };
        </script>
        <script async type="text/javascript" src="f22_game.js"></script>
    </body>
</html>
